# DAY 1

## 점심시간

12:15분

## 앤서블 
아래 작업은 "control"노드에서만 작업 수행.

```bash

## 기본 저장소에서 설치

dnf search ansible
> ansible
dnf install ansible -y
dnf search ansible-navigator

## 파이선 저장소에서 설치

dnf install python-pip
pip install ansible ansible-navigator

## 비공개 및 공개키 생성 및 배포

ssh-keygen -t rsa -N '' -f ~/.ssh/id_rsa
dnf install sshpass -y

ssh-copy-id root@10.10.10.250
ssh-copy-id root@10.10.10.1
ssh-copy-id root@10.10.10.2
ssh-copy-id root@10.10.10.3
ssh-copy-id root@10.10.10.4
```

## 설치 검증

"control"에서 다음과 같이 명령어 실행.

```bash

ansible all -i 10.10.10.250,10.10.10.1,10.10.10.2,10.10.10.3 -m ping

```

## 에디터 추가 설정

```bash
dnf search vim
dnf install vim-ale vim-ansible yamllint
vi ~/.vimrc
```

## 문법 테스트 및 확인

```bash
vim syntax1.yaml
```

```yaml
---
- name: first playbook
  hosts: all

  tasks:
    - name: first step module
      ping:
...
```

```bash
ansible-playbook -i10.10.10.1,10.10.10.2,10.10.10.3 syntax1.yaml
```

## 문법

```yaml
- name:
  hosts: all

  tasks:
    - name: 한글로는 작성하지 않음.
      shell: ls -l /tmp

```


# DAY 2

앤서블 애드훅부터 ~ 플레이북 만드는것.
- 조건문
- 파이썬에서 사용하는 Jinja2 템플릿 
- 서비스 구성(role)
- 특정 앤서블 모듈을 통해서 서비스 구성

```bash
ansible-doc -l
> posix


```

## 기본구성

앤서블 플레이북 생성 시, 일반적으로 작업 디렉터리를 생성. 

1. ansible.cfg
2. playbook
3. files
4. template files
5. roles directory

```bash
mkdir ansible
ansible-config init --disabled -t all > ~/ansible/ansible.cfg # touch ansible.cfg
-------------------
    \
     `---> /etc/ansible/ansible.cfg

vim ansible.cfg
> [defaults]
> inventory = /root/ansible/hosts
> # roles_path={{ ANSIBLE_HOME ~ "/roles:/usr/share/ansible/roles:/etc/ansible/roles" }}
> roles_path = roles:/usr/share/ansible/roles:/etc/ansible/roles
> remote_user = lab_user
>
> [privilege_escalation]
> # become_method = sudo 
> # become = true
> # become_user = root

```

### 연습문제

다음과 같이 앤서블 프로젝트 디렉터리를 생성 후, ansible설정을 적용한다. 앤서블 사용자 계정은 "anslab"를 사용한다.

1. 앤서블 사용자 디렉터리에 "ansible"작업 디렉터리를 구성 및 생성한다.
2. 설정 파일은 ansible에 생성한다.
3. 인벤토리 파일 이름은 hosts로 한다.
4. roles 경로 ansible/roles를 추가한다.
5. 외부에 접근 시 사용하는 계정은 remoteuser으로 설정한다.

__추가__

인벤토리 파일에는 다음과 같이 서버 정보가 입력이 되어야 한다.

```INI
node1.example.com node2.example.com node3.example.com
```

### 연습문제

control에 있는 저장소 파일을 각 노드에 배포한다. 내부 저장소 주소는 다음과 같다.

http://repo.example.com

1. repos에 있는 저장소 파일을 모든 노드에 배포한다.
2. 내부 저장소 주소(repo.example.com)를 각 노드에 등록한다.
3. 위의 애드훅 내용은 repo.sh에 작성 후 실행한다.

+ GPG KEY



!!결과


```bash
ansible all -b -m copy -a 'src=repos/rocky.repo dest=/etc/yum.repos.d/'

ansible-doc -l | grep repos
ansible-doc yum_repository

ansible all -b -m yum_repository -a 'name=internal description=hehe file=internal.repo baseurl=http://repo.example.com gpgcheck=0'

ansible all -b -m yum_repository -a 'name=internal description=hehe file=internal.repo baseurl=http://repo.example.com gpgcheck=1 gpgkey=http://repo.example.com/gpg.key'

vi repos.sh
> #!/bin/bash
> ansible all -b -m copy -a src="repos/rocky.repo" -a dest="/etc/yum.repos.d/"
> ansible all -b -m yum_repository -a 'name=internal description=hehe file=internal baseurl=http://repo.example.com gpgcheck=0' 
chmod o+x repos.sh
./repos.sh

node1~3# dnf repolist
> baseos
> appstream
> internal

ansible all -u remoteuser -b -m file -a 'state=absent path=/etc/yum.repos.d/*.repo'
```

방화벽 설정 혹은 영구적 중지

```bash

systemctl disable --now firewalld

firewall-cmd --add-service=http
firewall-cmd --add-service=http --permanent
```

## 압축

1. tar명령어를 직접적으로 사용하는 방법
2. archive모듈를 통해서 압축하는 방법


만약 다음과 같은 조건으로 작업을 한다면...

1. /tmp/backup이라는 디렉터리 생성.
2. /etc/디렉터리를 백업 후 /tmp/backup/에 보관.
3. 압축파일 이름은 etcbackup.tar.gz
4. control노드로 내려받기.
5. 내려받기하는 위치를

```bash
vi backup.yaml
```

```yaml
---
- hosts: localhost ## control

  tasks:
    - name: create backup directory
      file:
        path: /backup
        state: directory

- hosts: all  ## node1, node2, node3
  tasks:
    - name: make a /tmp/backup directory
      file:
        path: /tmp/backup
        state: directory
        mode: 0755

    - name: archive to /etc/ directory
      archive:
        path: /etc/
        dest: /tmp/backup/etcbackup.tar.gz 
        mode: 0755
    - name: donwload control node for all nodes
```


# DAY 3

# DAY 4